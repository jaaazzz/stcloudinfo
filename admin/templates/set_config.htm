<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>系统设置</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv= "X-UA-Compatible" content = "IE=edge,chrome=1"/>
    <link href="styles/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="styles/style.css" rel="stylesheet" type="text/css" />
    <link href="styles/app_base.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/placeholder.js"></script>
    <link href="js/sweetalert.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="js/sweetalert.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.js"></script>
    <script type="text/javascript" src="js/init.js"></script>
    <style type="text/css">
        .page_content .config_line{
            margin:10px 0;
            font-size: 14px;
        }
        .config_line .name{
            float:left;
            width:170px;
            line-height: 21px;
        }
        .config_line .input_css{
            float: left;
        }
        .config_line .input_css input{
            width:300px;
        }
        .cate_div,.app_div{
            width: 100%;
            height: 30px;
            border: 1px solid #dcdcdc;
            position: relative;
            margin: -1px;
        }
        .config_line .disable{
            /*opacity: 0.5;*/
            /*filter:alpha(opacity=50);*/
            /* Firefox,Safari(WebKit),Opera */
            /*-ms-filter:alpha(opacity=50);*/
            /*background-color:#666666 ;*/
        }
        #cate_div_list,#app_div_list{
            color: #333333;
            width: 300px;
        }
        .cate_div label,.app_div label{
            width:100%;
            font-weight: normal;
            cursor: pointer;
            margin-bottom: 0;
            padding: 5px 0 0 5px;
        }
        .page_content{
            color: #666666;
        }
        .cate_oprate{
            position: absolute;
            right: 5px;
            top:3px;
            display: none;
        }
        .cate_oprate img{
            cursor: pointer;
        }
        .add_cat,.add_app{
            border: 2px solid #3a85c6;
            color: #3a85c6;
            cursor: pointer;
            font-size: 17px;
            margin-top: 1px;
            text-align: center;
        }
        .btn_save{
            background-color: #52B678;
            width: 120px;
            height: 35px;
            color: white;
            border: none;
            margin-top: 25px;
            border-radius: 3px;
        }
        .app_list{
            max-height: 260px;
            overflow-y: auto;
            height: 260px;
        }
        .app_list label{
            /*display: block;*/
            /*margin: 10px 5px;*/
        }
        .app_list label input{
            margin-left: 5px;
        }
        #img_btn{
            opacity: 0;width: 100%;height: 100%;cursor: pointer;
            filter: progid:DXImageTransform.Microsoft.Alpha(opacity=0);
            position: absolute;top:0;
        }
        .addr_set{
            font-size: 14px;
            border-bottom: 1px solid #dcdcdc;
            height: 30px;
        }
    </style>
</head>

<body>
{include file="/library/header.htm"}
{include file="/library/left.htm"}
<div class="page_container">
    <div class="page_title" style="border: none">系统设置</div>
    <div class="page_content">
        <form id="set_config_form" action="set_config.php" method="post">
            <div>
                <div class="addr_set">地址设置</div>
                <div class="config_line">
                    <div class="name" style="">外网站点地址：</div>
                    <div class="input_css"><input type="text"  name="out_myself" value="{$out_myself}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name" style="">内网站点地址：</div>
                    <div class="input_css"><input type="text"  name="myself" value="{$myself}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name" style="">外网云狗地址：</div>
                    <div class="input_css"><input type="text"  name="out_cloud_dog" value="{$out_cloud_dog}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name" style="">内网云狗地址：</div>
                    <div class="input_css"><input type="text"  name="cloud_dog" value="{$cloud_dog}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name">文件服务器地址：</div>
                    <div class="input_css"><input type="text"  name="file_server" value="{$file_server}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name">内网文件服务器地址：</div>
                    <div class="input_css"><input type="text"  name="internal_file_server" value="{$internal_file_server}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line">
                    <div class="name">openstack地址：</div>
                    <div class="input_css"><input type="text"  name="openstack_ip" value="{$openstack_ip}" /></div>
                    <div style="clear: both;"></div>
                </div>

                <div class="config_line" style="display:none;">
                    <div class="name">数据库用户名：</div>
                    <div class="input_css"><input type="text"  name="db_user" value="{$db_user}" /></div>
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line" style="display:none;">
                    <div class="name">数据库密码：</div>
                    <div class="input_css"><input type="text"  name="db_pass" value="{$db_pass}" /></div>
                    <div style="clear: both;"></div>
                </div>

                <div class="addr_set">门户设置</div>
                <div class="config_line">
                    <div class="name">门户名称设置：</div>
                    <div class="input_css"><input type="text"  name="cloud_name" value="{$cloud_name}" /></div>
                    <div style="clear: both;"></div>
                </div>


                <div class="config_line" style="position: absolute;left: 665px;top: 492px">

                    <div class="name">应用分类管理：</div>
                    <div class="input_css disable" id="cate_div_list">
                        <div id="real_list">
                            {foreach from=$cate_list item=cate}
                            <div class="cate_div" data-id="{$cate.id}" data-name="{$cate.name}">
                                <div style="width:100%;height: 100%"><label data-id="{$cate.id}" placeholder="{$cate.name}" >{$cate.name}</label></div>
                                <div class="cate_oprate">
                                    <img src="images/pen.png" class="cate_edit" style="margin-right:5px" alt="编辑"/>
                                    <img src="images/delete.png" alt="删除" onclick="del_category(this)"/>
                                </div>
                            </div>
                            {/foreach}
                        </div>
                        <div  class="add_cat">
                            +添加分类
                        </div>
                        <div style="color: red;font-size: 11px;margin-top: 3px">注：可以通过拖动改变分类排列顺序</div>
                    </div>
                    <!--<div><a class="add_cate">编辑</a></div>-->
                    <div style="clear: both;"></div>
                </div>
                <div class="config_line" style="min-height:300px">
                    <div class="name">首页展示应用：</div>
                    <div class="input_css disable" id="app_div_list">
                        <div id="real_app_list">
                            {foreach from=$ind item=cate}
                            <div class="app_div" data-id="{$cate.id}" data-name="{$cate.app_name}">
                                <div style="width:100%;height: 100%"><label data-id="{$cate.id}" placeholder="{$cate.app_name}" >{$cate.app_name}</label></div>
                                <div class="cate_oprate">
                                    <img src="images/delete.png" alt="删除" onclick="del_app(this)"/>
                                </div>
                            </div>
                            {/foreach}
                        </div>

                        <div  class="add_app">
                            +添加首页展示应用
                        </div>
                        <div style="color: red;font-size: 11px;margin-top: 3px">注：可以通过拖动改变首页显示顺序</div>
                    </div>
                    <!--<div><a class="add_cate">编辑</a></div>-->
                    <div style="clear: both;"></div>
                </div>
            </div>
            <input type="hidden" id="cate_list" name="cate_list" />
            <input type="hidden" id="app_list" name="app_list" />
            <input type="hidden" {if $logo_url}value="{$logo_url}"{/if} id="logo" name="logo" />
            <input type="hidden" id="act" name="act" value="save" />
        </form>
        <div class="config_line">
            <div class="name" style="padding-top: 20px">门户LOGO：</div>
            <form id="logo_form" method="post" action="" target="logo_upload_iframe"  enctype="multipart/form-data">
            <div class="input_css" style="width: 65px;height: 65px;position: relative;background-color:#ebeaea">
                <img src="{if $logo}{$logo}{else}images/symbol_add.png{/if}" class="logo_img" title="选择上传LOGO" alt="选择上传LOGO" style="width: 65px;height: 65px;cursor: pointer"/>
                <input type="file" id="img_btn" onchange="imageSubmit();"  name="gs_upload_file" />
            </div>
            <iframe id="logo_upload_iframe" style="display:none;" name="logo_upload_iframe">
                <html>
                <head></head>
                <body></body>
                </html>
            </iframe>
            </form>
            <div style="clear: both;"></div>
        </div>
        <div><input class="btn_save" type="button"  value="保存" /> </div>
    </div>

    <div class="modal_background set_app_bg">
        <div class="modal_box set_app_index" style="width: 525px;height: 400px; ">
            <div class="modal-header">
                <span class="title-word">选择应用</span>
                <span class="close" aria-hidden="true" data-dismiss="modal"></span>
            </div>
            <div class="modal-body">
                <div class="app_list">
                    <table class="app_table" style="margin-left: 0">
                        <thead>
                        <tr>
                            <th width="70%"><input type="checkbox"  class="head_check"/>应用名称</th>
                            <th width="30%">发布者</th>
                        </tr>
                        </thead>
                        <tbody>
                        {foreach from=$ind2 item=cate}
                        <tr style="height: 30px">
                            <td><label><input type="checkbox" value="{$cate.id}"/>{$cate.app_name}</label></td>
                            <td>{$cate.user_name}</td>
                        </tr>
                        {/foreach}
                        </tbody>
                    </table>
                </div>
                <div class="modal_btns">
                    <a class="modal_btn app_sure" style="margin-left: 0">确定</a>
                    <a class="modal_btn cancel">取消</a>
                </div>
            </div>
        </div>

        <div class="modal_box host" style="width: 450px;height: 210px; ">
            <div class="modal-header">
                <span class="title-word">提示</span>
                <span class="close" aria-hidden="true" data-dismiss="modal"></span>
            </div>
            <div class="modal-body">
                <div style="margin: 25px 0">确定要删除该分类?</div>
                <div class="modal_btns">
                    <a class="modal_btn sure host" style="margin-left: 0">暂不删除</a>
                    <a class="modal_btn cancel host">立即删除</a>
                </div>
            </div>
        </div>

    </div>


</div>
</body>
<script>
    var cate_obj=null;
    $(function(){
        $('.btn_save').on('click',function(){
            var list = [];
           $('.cate_div').each(function(index,obj){
               var cate = {};
               var res = $(this);
               var label = res.find('label').html();
               var data_id = res.find('label').attr('data-id');
               if(label != ''&&label!='请输入分类名称'){
                   cate.id = data_id;
                   cate.value = label;
                   cate.app_order=index;
                   list.push(cate);
               }
           });
            $('#cate_list').val(JSON.stringify(list));

            var list2 = [];
            $('.app_div').each(function(index,obj){
                var app = {};
                var res = $(this);
                var label = res.find('label').html();
                var data_id = res.find('label').attr('data-id');
                if(label != ''){
                    app.id = data_id;
                    app.show_order=index;
                    list2.push(app);
                }
            });
            $('#app_list').val(JSON.stringify(list2));
            $('#set_config_form').submit();
        });
        $('.add_cate').on('click',function(){
           //$('#cate_div_list').append($('.cate_div:last').clone());
            $(".cate_div input").attr('disabled',false);
        });


        $(document).on('blur','.cate_div input',function(){
            var id=$(this).attr('data-id');
            var that=$(this).parent();

            if($(".cate_div label[placeholder="+$(this).val()+"]").length){
                $(this).val('');
                $(this).focus();
                return;
            }
            var name=$(this).val()||'请输入分类名称';
            var label='<label data-id="'+id+'"  placeholder="'+name+'"  style="width:100%;font-weight: normal;cursor: pointer">'+name+'</label>';
            $(this).remove();
            that.html(label);
        });
        $(".add_cat").click(function(){
            var str='<div class="cate_div">'+
                    '<div style="width: 100%;"><label data-id="" placeholder="请输入分类名称" style="width:100%;font-weight: normal;cursor: pointer">请输入分类名称</label></div>'+
                    '<div class="cate_oprate"><img src="images/pen.png" class="cate_edit" style="margin-right:5px" alt="编辑"/><img src="images/delete.png" alt="删除" onclick="del_category(this)"/></div>'+
                    '</div>';
            $("#real_list").append(str);
            $(".cate_div").last().find('.cate_edit').trigger('click');
        });

        $( "#real_list" ).sortable();
        $( "#real_app_list" ).sortable();

        $(document).on('click','.cate_edit',function (){
            var $label=$(this).parents('.cate_div').find('label');
            var id=$label.attr('data-id');
            var that=$label.parent();
            var name=$label.attr('placeholder');
            var value=name=="请输入分类名称"?'':name;
            var input='<input type="text" style="width:100%;"  placeholder="'+name+'"  value="'+value+'" data-id="'+id+'" />';
            $label.remove();
            that.html(input);
            $(this).parent().hide();
            $(that).find('input').focus();
        });

        $(document).on('mouseenter','.cate_div',function (){
            if($(this).find('input').length>0){
                return;
            }
            var $div=$(this).find('.cate_oprate');
            $div.show();
        });
        $(document).on('mouseleave','.cate_div',function (){
            var $div=$(this).find('.cate_oprate');
            $div.hide();

        });
    });

    $(function () {
        $(".add_app").click(function () {
//            $.post('set_config.php',{act:'get_apps'},function (res) {
//                res=JSON.parse(res);
//                console.log(res);
//            });
            $(".modal_background.set_app_bg,.modal_box.set_app_index").show();
        });
        $(".modal_btn.app_sure").click(function () {
           $(".app_list tbody input[type=checkbox]").each(function () {
              if(this.checked&&!$(".app_div[data-id="+this.value+"]").length){
                  var str='<div class="app_div" data-id="'+this.value+'" data-name="'+$(this).parent().text()+'">'+
                            '<div style="width:100%;height: 100%"><label data-id="'+this.value+'" placeholder="'+$(this).parent().text()+'" >'+$(this).parent().text()+'</label></div>'+
                            '<div class="cate_oprate">'+
                                '<img src="images/delete.png" alt="删除" onclick="del_app(this)"/>'+
                            '</div>'+
                          '</div>';
                  $("#real_app_list").append(str);
              }

           });
            $(".modal_background.set_app_bg,.modal_box.set_app_index").hide();
            var m_height=$('.page_container').css('height');
            $('.left').css({'height':parseInt(m_height)+15+'px'});
        });

        $(document).on('mouseenter','.app_div',function (){
            var $div=$(this).find('.cate_oprate');
            $div.show();
        });
        $(document).on('mouseleave','.app_div',function (){
            var $div=$(this).find('.cate_oprate');
            $div.hide();
        });
        //暂不删除
        $(".sure.host").click(function () {
            $(".modal_background.set_app_bg,.modal_box.host").hide();
        })
        //立即删除
        $(".cancel.host").click(function () {
            var id=cate_obj.attr('data-id');
            var name=cate_obj.attr('data-name');
            cate_obj.remove();
            cate_obj=null;
            if(id){
                $.post('set_config.php',{act:'del',id:id,name:name},function(res){
                    if(res=='ok'){
                        swal({
                            title: '删除成功',
                            text: "",
                            type: "success",
                            allowOutsideClick:true,
                            confirmButtonText: "关闭"
                        });
                        location.reload();
                    }else{
                        swal({
                            title: '删除出错',
                            text: "",
                            type: "error",
                            allowOutsideClick:true,
                            confirmButtonText: "关闭"
                        });
                    }
                });
            }else{
                $(".modal_background.set_app_bg,.modal_box.host").hide();
            }
        })
    });

    function imageSubmit(){
        var fileName = $('#img_btn').val();
        var file_url='{$real_file_server}';
        var fileType = fileName.substring(fileName.lastIndexOf('.')+1,fileName.length);
        fileType = fileType.toLowerCase();
        var checkFile = checkFileType(fileType);
        if (checkFile) {
            $('#logo_form').attr('action',file_url+'/file/uploadex/'+fileType);
            $('#logo_upload_iframe').attr('src',file_url+'/file/uploadex/'+fileType);
            $('#logo_form').submit();
            return true;
        }else{
            alert('文件类型不支持！');
            return false;
        };
    }

    function checkFileType(fileType){
        var support_file_type;
        support_file_type= new Array('png','jpg','jpeg','gif','bmp');
        for (var i = 0; i < support_file_type.length; i++) {
            if (fileType == support_file_type[i]) {
                return true;
            };
        };
        return false;
    }
    var onMessage = function(data){
        console.info(data);
        var file_info = data.data;
        var upload_type=$("#fileType").val();
        if (file_info){
            file_info = $.parseJSON(file_info);
            var upload_status = file_info.success;
            var file_guid = "";
            var file_size = "";
            var original_file_name = "";
            var store_file_name = "";
            var file_type = "";
            if (upload_status){
                //上传成功
                var data = file_info.result;
                file_guid = data.file_guid;
                file_size = data.file_size;
                original_file_name = data.original_file_name;
                store_file_name = data.store_file_name;
                var index = original_file_name.lastIndexOf(".");
                file_type = original_file_name.substring(index+1,original_file_name.length);

                var file_url='{$real_file_server}';
                var file_key = file_type+"/"+file_guid+"/65";
                // var url =file_url+"/file/downloadex/"+file_key;
                var url ='/uploadlink/file/'+data.store_path.slice(-7)+data.store_file_name;
                $('.logo_img').attr('src',file_url+url);
                $("#logo").val(url);
                //pingzheng_file='/file/downloadex/'+file_key;
            }else{
                //上传失败
                var data = file_info.result;
                var remsg = file_info.msg;
                alert(remsg);
                return;
            }

        }
    }
    if (window.addEventListener) {
        window.addEventListener('message', onMessage, false);
    }else{
        window.attachEvent('onmessage', onMessage);
    };

    function del_category(e){
        $(".modal_background.set_app_bg,.modal_box.host").show();
        cate_obj=$(e).parents('.cate_div');
    }
    function del_app(e){
        var $del=$(e).parents('.app_div');
        $del.remove();
         var m_height=$('.page_container').css('height');
        $('.left').css({'height':parseInt(m_height)+15+'px'});
    }
</script>
</html>